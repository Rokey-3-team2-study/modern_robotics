# Modern Robotics

## Chapter 10. Motion Planning, 동작 계획

### 10.1 Overview of Motion Planning, 개괄

> 모션 플래닝은 로봇이 주어진 환경 내에서 충돌 없이 시작 위치에서 목표 위치로 이동하기 위한 경로 또는 궤적을 생성하는 문제를 해결

- Motion Planning 문제 유형
    - Path : 시간 고려 x, 순수하게 기하학적인 경로를 찾는 문제
    - Trajectory : 경로에 시간 정보(속도, 가속도)를 부여하여 궤적을 생성
    - Task : 로봇이 수행해야 할 작업을 일련의 기본 동작들로 분할하여 각 동작에 대한 적절한 모션 플래닝 수행
    - 최적 vs. 충분(근사)
    - 정량적 vs. 정성적
    - 장애물

- Motion Planner의 특성
    - 완전성 : 충돌 없는 경로가 존재하면 반드시 찾는다는 성질
    - 확률적 완전성 : 샘플링 기반 알고리즘, 시간이 무한할 때, 성공 확률 1에 수렴
    - 최적성 : 찾은 경로가 최단 거리, 최소 에너지 소모 등의 비용 최적화를 만족하는가.
    - 계산 복잡도(효율성) : 복잡한 환경에서도 실시간으로 경로를 계산 가능해야 함

- Motion Planning 기법
    - 알고리즘
        - 완전 : 상태 공간의 위상, 기하를 표현 → 계산 복잡
        - 격자 : 상태 공간 이산화 = 격자
        - 샘플링 : 상태 공간에서 특정 샘플 선택, 그래프/트리 구성
        - 가상 퍼텐셜 : 척력/인력 개념 사용, 국소해(local minima) 문제 발생 가능
        - 비선형적(최적화) : 비용함수 최소화
        - 곡선화 : Motion Planner를 통해 찾은 동작을 부드럽게 만듦

    - 이론
        - Classic : 상태 공간을 수학적으로 모델링하고, 경로를 직접 계산
        - Sampling-based : 상태 공간에서 임의의 구성을 샘플링하고 연결
        - Optimization-based : 경로 또는 궤적을 목적 함수 최소화의 문제로 공식화

### 10.2 Foundations, 기초

> 모션 플래닝 문제를 해결하기 위한 핵심 개념

- 상태 공간 장애물
    - 작업 공간 장애물 = 자유 공간 + 장애물 공간
        - 자유 공간이 장애물 공간으로 인해 연속 요소로 분리되고,
        - ${q_{start}}$ 와 ${q_{goal}}$ 이 동일 연속 요소에 있지 않으면,
        - *해가 없음*

- 장애물까지의 거리 측정과 충돌 감지
    - 활동 장애물 : ${\beta}$
    - 자세 : ${q}$
    - 장애물로부터 로봇까지의 거리 : ${d(q, \beta)}$, 거리 함수
        - \+ : 장애물과 접촉 없음
        - 0 : 장애물과 접촉
        - \- : 장애물 겹침 및 관통
    - 과정
        - 거리 측정 알고리즘 : 거리 함수를 결정하고
        - 충돌 감지 : 거리함수가 0 이상인지 확인

- 그래프와 트리
    - 노드(node) : 특정 자세 혹은 상태, ${n_i}$
    - 간선(edge) : 노드 간 이동 가능 경로, ${e}$
    - 방향
        - 유도형(유향)
        - 비유도형(무향)
    - 가중치 : 간선에 비용이 있는 그래프
    - 트리
        - 순환 x, 각 노드는 최대 하나의 부모 노드, root/leaf 노드

- 그래프 탐색
    - A* 탐색 : 최단 경로 탐색 알고리즘
        - 
    - 다익스트라
        - 
    - BFS
    - 차선 A* 탐색

### 10.3 Complete Path Planners, 완전 계획기

- 완전한 플래너란? (완전성)
    - 충돌 없는 경로가 존재하면 반드시 찾아냄
    - 경로가 존재하지 않는 경우, 그것을 올바르게 판단함

- 접근성 : 로봇이 어떤 지점(목표 위치 등)에 도달 가능한가?

- 연결성 : 공간 안의 두 점이 하나의 연속된 경로로 연결돼 있는가?

### 10.4 Grid Methods, 격자 계획기

> 상태 공간을 격자로 분할한 후, 이 격자를 기반으로 로봇의 이동 가능 경로를 탐색하는 방법

- 개념
    - 상태 공간을 고정된 해상도의 격자로 분할
    - 각 셀은 로봇이 그 위치에 있을 수 있는지에 따라 Free(이동 가능) 또는 Obstacle(장애물)로 구분
    - 로봇은 한 셀에서 인접한 셀로만 이동 가능 (상하좌우 또는 대각선)
        - 상하좌우 + 대각선 : 유클리드 거리
        - 상하좌우만 가능 : 맨해튼 거리
    - 경로 탐색은 시작 셀에서 목표 셀까지 충돌 없이 도달할 수 있는 경로를 찾아내는 과정

- 다중 해상도 격자 표현
    - 해상도가 중요한 문제를 해결하기 위한, 공간의 특성에 따라 해상도를 다르게 설정하는 방식
    - 특징
        - 복잡하고 장애물이 많은 지역은 세밀하게 분할 : 고해상도
        - 단순하고 자유로운 공간은 거칠게 분할 : 저해상도
        - 4진(=2D)/8진(=3D) 구조로 구현하는 경우가 많음

- 동작 제약 조건을 고려한 그리드 방법
    - 현실의 로봇은 물리적인 동작 제약(= 방향, 회전 반경, 속도/가속도 등)을 고려한 방법
    - 가능한 이동 방향 및 제약 조건을 반영한 motion primitive(= 정의된 동작 시나리오) 사용
    - motion primitive 예시 : 자동차형 로봇
        - 직진
        - 좌회전 반지름 5m로 15도 회전하며 전진
        - 우회전 반지름 5m로 15도 회전하며 전진
        - 후진

### 10.5 Sampling Methods, 샘플링 기법

> 고차원 상태 공간(높은 자유도)에서 경로를 효율적으로 찾기 위해 사용되는 기법

- 개념
    - 명시적인 구성 공간 모델링 없이, 충돌 검사만을 이용해 경로를 찾음
    - 장애물을 명확하게 수학적으로 표현하지 않음
    - 대신, 구성 공간에 무작위로 샘플을 뽑아서 연결성(graph) 을 만들어 감

- RRT (Rapidly-Exploring Random Tree) 알고리즘
    - 

- PRM (Probabilistic Roadmap) 알고리즘
    - 

### 10.6 Virtual Potential Fields, 가상 퍼텐셜 장

> 물리학적인 개념을 차용하여, 로봇을 마치 힘(포텐셜)에 의해 움직이는 입자처럼 다루는 방식

- 개념
    - 목표 = 인력(Attractive Force), 장애물 = 척력(Repulsive Force)
    - 전체 포텐셜 필드 : ${U(q)=U_{att}(q)+U_{rep}(q)}$

- 상태 공간 내의 점
    - 인력 포텐셜
        - ${U_{att}(q) = \frac{1}{2}k_{att}\cdot||q-q_{goal}||^2}$
        - ${F_{att}(q) = - \nabla U_{att}(q) = -k_{att}(q-q_{goal})}$
    - 척력 포텐셜
        - ${U_{rep}(q) = \begin{cases} \frac{1}{2} k_{\text{rep}} \left( \frac{1}{\rho(q)} - \frac{1}{\rho_0} \right)^2 & \text{if } \rho(q) \leq \rho_0 \\ 0 & \text{if } \rho(q) > \rho_0 \end{cases}}$
        - ${F_{rep}(q) = - \nabla U_{rep}(q)}$
    - 전체 포텐셜 및 힘
        - ${U(q) = U_{att}(q) + U_{rep}(q)}$
        - ${F(q) = -\nabla U(q)}$

- 항법 함수
    - 포텐셜 장의 가장 큰 문제는 국소점(Local Minima) = 목표가 아닌 중간 지점에서 인력과 척력이 상쇄되어 정지
    - 항법 함수를 통해 국소점을 피하고 경사도를 따름
    - 전체 항법 함수 : ${\varphi(q) = \displaystyle \frac{||q - q_{goal}||^2}{||q - q_{goal}||^2 + \beta(q)}}$
    - 항법 함수 기반 이동 법칙 : ${\dot{q} = -\nabla \varphi(q)}$

- 작업 공간 퍼텐셜
    - 작업 공간에서 직접 포텐션 필드를 정의하고 적용하는 방법을 설명
    - 목표점에 의한 인력 : ${U_{att}(x) = \frac{1}{2}k_{att}\cdot||x-x_{goal}||^2}$
    - 장애물에 의한 척력 : ${U_{rep}(x) = \begin{cases} \frac{1}{2} k_{\text{rep}} \left( \frac{1}{\rho(x)} - \frac{1}{\rho_0} \right)^2 & \text{if } \rho(x) \leq \rho_0 \\ 0 & \text{if } \rho(x) > \rho_0 \end{cases}}$

- 차륜 이동 로봇
    - 운동학적 제약을 고려해야 한다.
    - 제어 법칙 : ${u = F_{proj}(q) - B\dot{q}}$
    - ${\dot{q} = F_{proj}(q) = (I-A^T(q)(A(q)A^T(q))^{-1}A(q))F(q)}$

- 모션 플래너에서의 포텐셜 필드 활용 : 플래닝 알고리즘에 보조 도구로 사용
    - RRT : 샘플링 방향을 포텐셜 필드 방향으로 유도
    - PRM : 로드맵 생성 시 충돌 가능성 높은 방향 회피
    - 최적화 기반 방법 : 초기 경로에 포텐셜 필드 기반 힘을 가해 스무딩

### 10.7 Nonlinear Optimization, 비선형적 최적화

> 경로의 품질 향상과 물리적 제약 조건 충족을 위해 활용

- 최적해의 도출은 어렵다.
    - minimizing : ${ \int_{0}^{T} \| \dot{x}(t) \|^2 dt}$

### 10.8 Smoothing, 곡선화

> 생성된 경로를 더 부드럽고 현실적으로 개선하기 위한 후처리 과정입니다

- 방법
    - 비선형 최적화 : 후처리 방법으로 비선형 최적화 사용
        - ${J = \frac{1}{2} \int_0^T \dot{u}^T(t) \dot{u}(t) dt}$
    - 분할 및 재결합 : 기존 경로의 두 점 사이를 로컬 플래너로 다시 연결하여 더 짧고 부드러운 경로로 대체
        - 경로 상 임의 두 점을 선택
        - 로컬 플래너로 두 점 사이의 새 경로 시도
        - 충돌이 없다면 기존 구간을 대체
        - 위 과정을 여러 번 반복하거나, 재귀적으로 분할하여 부드러운 경로 생성성